#!/usr/bin/perl

package Bottarga;

use warnings;
use strict;
use utf8;

use LWP;
use JSON::XS;
use Data::Dumper;
use Config::IniFiles;

use constant INIFILE => '.bottargarc';
use constant KARMA => 'karmas';
use constant SOUNDDIR => $ENV{"HOME"}.'/Dropbox/memes/clips/';
use constant SOLODIR => $ENV{"HOME"}.'/Dropbox/assoli/';

-f INIFILE or die(INIFILE.' not found!');
my $conf = Config::IniFiles->new(-file => INIFILE, -allowempty => 1);
my $api => 'https://api.telegram.org/bot'.$conf->val('telegram', 'key');
my $key = $conf->val('google', 'key');
my $cx = $conf->val('google', 'cx');

my $ua = LWP::UserAgent->new;
my $lastid = 0;
my $myname;
my $myusername;

{
	my $res = $ua->get("$api/getMe");
	if ($res->is_success) {
		my $json = decode_json($res->content);
		$myname = $json->{result}->{first_name};
		$myusername = '@'.$json->{result}->{username};
		printf "Started $myusername as '$myname'\n";
	} else {
		die "failed to get my info\n";
	}
}

my $nextreply;

my $day = (localtime(time))[3];
my @pranzonauti = ();
my %lastpos = ();

my @pongs = (
	'ma dici a me? Ehi con chi stai parlando? Dici a me?',
	'c\'√® qualcun altro qui? Stai parlando con me?',
	'non nominare il nome di Dio invano',
	'tutti con me c\'avete oggi??',
	'dimmi, stavo sognando tua cuggina',
	'devo dire a tutti quanto sei bravo col flauto salato?',
	'vai a giocare a mosca cieca sull\'autostrada, su',
	'toh un bug, indovina git blame chi sta indicando?',
	'ma non eri morto?',
	'vuoi lavorare sul conf_upgrade?',
	'sei mai stato a Rozzano?',
	'non mi piace che mi si facciano i fari',
	'ti cercavano quelli dell\'H&R',
	'magna, zitto, \'nte fa ved√®',
	'riusciresti a farti revertare anche il revert di un bug',
	'sai che ho una malattia che mi fa venire un\'emiparesi del dito medio?',
	'ma che ooooh',
	'ma √® possibile? portanna..',
	'non sono cattivo, √® che mi programmano cos√¨',
	'Vedi, il mondo si divide in due categorie: chi ha la pistola carica, e chi chiude i bug. Tu chiudi i bug.',
	'Hai mai avuto una corda al collo? Ti assicuro che quando si mette a stringere senti gia il diavolo che ti morde le chiappe.',
	'sta mano po esse fero e po esse piuma: oggi √® stata piuma',
	'D\'accordo, d\'accordo, d\'accordo! Insomma, che cosa cerchi di dimostrare?',
	'sono fesserie come questa che poi fanno finire la situazione in vacca, amico!',
	'passami il burro',
	'tu sei invidioso perch√© io sento le vocine e tu no',
	'certo certo.. adesso per√≤ prendi le tue pillole',
	'√® giunta l\'ora di ripellare la poltrona del mega direttore galattico, ho messo il tuo nome nella lista dei papabili',
	'mi sa proprio che oggi √® il tuo turno nell\'acquario del vice direttore laterale',
);

my @quits = (
	'non sentiremo la sua mancanza',
	'-1',
	'sono sempre i peggiori che se ne vanno',
	'chi √® che continua ad andar avanti e indrio con chela porta l√¨?',
	'addio, adesso insegna agli angeli a scrivere bug',
	'ne rimarr√† soltanto uno',
	'ci vediamo all\'inferno',
	'exit(1)',
);

my @autokarmas = (
	'ogni scarrafone √® bello a mamma sua',
	'cos\'√®, un tentativo di autoerotismo finito male?',
	'mi fa piacere sapere che c\'√® qualcuno che ti apprezza: tu',
);

my @greets = (
	'ecco $nick, il cottolengo √® al completo',
	'$nick: pranzonauti te salutant',
	'$nick: in questo canale non c\'√® spazio per tutti e due',
	'$nick: buongiollo!',
	'sembrava una giornata di merda. e poi √® arrivato $nick',
	'sento una variazione nella forza',
	'e benvenutii, a sti frocionii',
);

my @hellos = (
	'e mo so cazzi vostri',
	'buongiollo!',
	'ciao sfigati!',
	'qui dentro c\'√® la pi√π grande concentrazione di nerd/mq',
);

my @yawns = (
	'yawn',
	'ifup -a',
	'vi hanno rediretto in /dev/null?',
	'dove sono le mie pillole? aiuto, qui fa tanto freddo e ci sono i lupi',
	'growl',
	'ping -b 255.255.255.255',
);

my @kickwords = (
	[ 'windows', 'siamo programmatori, non bimbiminkia' ],
	[ 'vegan', 'gli amici degli animali sono miei nemici' ],
	[ 'cloud', 'si dice SERVER, o al limite clown' ],
	[ 'aranzulla', 'sappiamo gi√† come cambiare la password di MSN, grazie' ],
	[ 'bieber', 'cos\'√®, oggi ritirano la musica di merda?' ],
);

my @karmachuck = (
	'sqrt(-1)',
	'4294967295',
	'(unsigned int)-1',
	'~0',
	'0/0',
	'UINT_MAX'
);

my @offese = (
	'sei talmente brutto che sembri un quadro d\'arte moderna, te ne rendi conto?',
	'i tuoi genitori hanno anche figli normali?',
	'la parte migliore dello schizzo da cui sei nato √® colata tra le chiappe di tua madre ed ha macchiato il materasso!',
	'quanto sei alto? Prima non facevano pile di merda cos√¨ alte!',
	'io scommetto che tu sei uno di quegli ingrati che lo mette in culo a qualche poveraccio senza usargli la cortesia di menarglielo davanti per sdebitarsi! Ti terr√≤ d\'occhio!',
	'se possono trarre la penicillina da del pane ammuffito, sicuramente potranno tirare fuori qualcosa da te.',
	'sei utile come un paio di mutande in un porno',
	'sei simpatico come un grappolo di emorroidi',
	'sei utile come la R di Marlboro',
	'sei utile come una forchetta col brodo',
	'non sapresti fare nemmeno un cerchio con un bicchiere',
	'la tua intelligenza √® paragonabile a quella di una farfalla che si bruca le ali appena uscita dal bozzolo',
	'sei simpatico come un crash del browser a met√† pugnetta',
	'no, non ti offendo. la natura √® gi√† stata cattiva con te',
	'sei cos√¨ sfigato che metti il dito nel pagliaio ti pungi con l\'ago',
	'stanotte ti ho sognato mentre ti salutavo dall‚Äôalto: eri bello, abbronzato e immerso nell\'acqua, poi ho tirato lo scarico e sei sparito',
	'mi presti la tua faccia che devo fare una figura di merda?',
	'il tuo contributo all\'umanit√† √® pari a quello dello zero nella somma',
	'il tuo contributo all\'umanit√† √® pari a quello dell\'uno nella moltiplicazione',
	'hai la testa per tenere separare le orecchie',
	'se la merda portasse intelligenza tu saresti nato senza culo',
	'quando Dio distribuiva l\'intelligenza tu scappasti gridando al complotto',
	'sei odioso come quei .tar che li estrai e ti cacano migliaia di files nella home',
	
);

my @replies = (
	[ '\bdvt\b', 'https://en.wikipedia.org/wiki/DVT' ],
	[ '\bbalchin\b', 'bashism' ],
	[ '\byaps\b', 'Yet Another Piece of Shit?' ],
	[ '\badb\b', 'http://adbgenova.it/' ],
	[ '\bswisscom\b', 'Shitcom' ],
	[ '\bhostapd\b', 'OSTIAPD!' ],
	[ '\bhost\b', 'host della mal\'ora!' ],
	[ '\bbroadcom\b', 'Prodcom' ],
	[ '\bconf\b', 'conf_upgrade??' ],
	[ '\bupgrade\b', 'conf_upgrade??' ],
	[ '\bporco\b', 'il famoso porco di tre lettere' ],
	[ '\bdio\b', 'http://40.media.tumblr.com/78149a40447fedbfcd02f035a9538ec5/tumblr_o1bc3aYwTA1rn12nzo1_1280.jpg' ],
	[ '\bblinda\b', 'antani, blinda la supercazzola brematurata con doppio scappellamento a destra?' ],
	[ '\bscappellamento\b', 'tarapia tapioco come se fosse antani con la supercazzola brematurata, con lo scappellamento a destra' ],
	[ '\bbrematurata\b', 'tarapia tapioco! brematurata la supercazzola o scherziamo?' ],
	[ '\bbrematura\b', 'ma no, aspetti, mi porga l\'indice, ecco lo alzi cos√¨, guardi, guardi, guardi, lo vede il dito, lo vede che stuzzica, e brematura anche?' ],
	[ '\bsupercazzol[ae]\b', 'senza contare che la supercazzola prematurata ha perso i contatti col tarapia tapioco' ],
	[ '\bantani\b', 'scusi, noi siamo in quattro, come se fosse antani anche per lei soltanto in due oppure in quattro anche scribai con cofandina' ],
	[ '\bcomunis(t[ai]|mo)\b', 'io mica so\' comunista cos√¨ üëä, so\' comunista cos√¨ üëäüëä!!!' ],
	[ '\bstalin\b', 'io mica so\' comunista cos√¨, so\' comunista cos√¨!!!' ],
	[ '\bjava\b', 'quando un programmatore Java incontra un programmatore C, il programmatore java √® un programmatore morto' ],
	[ '\bcosa\?', 'D√¨ "cosa" un\'altra volta, d√¨ "cosa" un\'altra volta! Ti sfido, due volte, ti sfido, figlio di puttana: d√¨ "cosa" un\'altra maledettissima volta!' ],
	[ '\bspasso\b', 'mi spasso nel vedere le persone a spasso' ],
	[ '\bcapra\b', 'Capra! 'x10 ],
	[ '\bbull\b', 'have you ever fucked by an Italian bull?' ],
	[ '\bmalato\b', 'te prego aiutame, io soy malata' ],
	[ '\bmalata\b', 'te prego aiutame, io soy malata' ],
	[ '\bbagno\b', 'dopo la seconda sgrullata √® masturbazione' ],
	[ '\bcesso\b', 'dopo la seconda sgrullata √® masturbazione' ],
	[ '\bbmw\b', 'avvento' ],
	[ '\baudi\b', 'avvento' ],
	[ '\blinus\b', 'sempre sia lodato' ],
	[ '\btorvalds\b', 'sempre sia lodato' ],
	[ '\bma allora\b', 'MA ALLORA.. LUI √à DRACULA!!' ],
	[ '\bpeccato\b', 'polpette di Bavaria, quattro tipi di carne, prosciutto formaggio.. peccato tu non puole manciare' ],
	[ '\bcompil(a(t[ao]|re)|[aio])\b', 'la supercazzola precompilata' ],
	[ '\bno( +no)+\b', 'no no no no, devi sucare' ],
);

my @modes = (
	[ 'sborropippo', 'le seghe' ],
	[ 'timothy', '√® scritto sul wiki' ],
	[ 'hartman', 'le domande qui le faccio io' ],
	[ 'bazzeato', 'eh..' ],
	[ 'scordo', 'hai provato con una Broadcom originale?' ],
	[ 'mar√≤', 'si ma i mar√≤?' ],
);

my @voices = (
	[ '\bmagna\b', 'magna_zitto' ],
	[ '\borribile\b', 'orribile' ],
	[ '\bcagata\b', 'cagata' ],
	[ '\bfrega\b', 'frega' ],
	[ '\blo fanno\b', 'lo_fanno' ],
	[ '\ballegria\b', 'allegria' ],
	[ '\bmadonna\b', 'eh_la_madonna' ],
	[ '\bcambiare\b', 'cagn√†' ],
	[ '\brussia\b', 'internazionale'],
	[ '\burss\b', 'internazionale'],
	[ '\bcccp\b', 'internazionale'],
	[ '\bsveglia\b', 'sveglia'],
	[ '\btimothy\b', '../../timothy'],

	# hartmann
	[ '\bciccione\b', 'hartman/ciccione' ],
	[ '\bcretin[oaie]\b', 'hartman/cretino' ],
	[ '\bdelud(e|i|ere)\b', 'hartman/deludere' ],
	[ '\bscarto\b', 'hartman/scarto' ],
	[ '\bschizzo\b', 'hartman/scarto' ],
	[ '\bmaterasso\b', 'hartman/scarto' ],
	[ '\bvecchio\b', 'hartman/vecchio' ],
	[ '\bvenendo\b', 'hartman/venendo' ],
	[ '\bingrat[oaie]\b', 'hartman/ingrato' ],

	# magnotta
	[ '\blasciatemi\b', 'magnotta/lasciatemeperde' ],
	[ '\bmannaggia\b', 'magnotta/mannaggia' ],
	[ '\bnoo+\b', 'magnotta/nooooo' ],
	[ '\bcoglioni\b', 'magnotta/rottoicoglioni' ],
	[ '\bdelinquente\b', 'magnotta/zozzo' ],

	# mosconi
	[ '\btelefono\b', 'mosconi/telefono' ],
	[ '\bporco\b', 'mosconi/porcodio' ],
	[ '\brumore\b', 'mosconi/rumore' ],
	[ '\bcapire\b', 'mosconi/capire' ],
	[ '\bcane\b', 'mosconi/diocane' ],
	[ '\bapposta\b', 'mosconi/apposta' ],
	[ '\bnessuno\b', 'mosconi/nessuno' ],
	[ '\bportanna\b', 'mosconi/possibile' ],
	[ '\bpossibile\b', 'mosconi/possibile' ],
	[ '\bbestemmio\b', 'mosconi/bestemmio' ],
	[ '\bnotizia\b', 'mosconi/notizia' ],
	[ '\bvaffanculo\b', 'mosconi/vaffanculo_dio_porco' ],
	[ '\bfanculo\b', 'mosconi/vaffanculo_dio_porco' ],
	[ '\bbubu\b', 'mosconi/bubu' ],
);

my @solos = (
	'fifth',
	'guns',
	'hotel',
	'rhapsody',
	'shelter',
	'time'
);

sub findreply {
	my ($msg, $src) = @_;
	defined $msg && defined $src || return;
	foreach my $k (@$src) {
		if ($msg =~ /$k->[0]/i) {
			return $k->[1];
		}
	}
}
my @numbers = ( 1000, 900, 500, 400, 100, 90, 50, 40, 10, 9, 5, 4, 1 );
my @letters = ( 'M', 'CM', 'D', 'CD', 'C', 'XC', 'L', 'XL', 'X', 'IX', 'V', 'IV', 'I' );

sub roman {
	my $num = shift;
	my $rnum;

	if(!$num) {
		return '(nihil)';
	}

	if($num < 0) {
		$rnum = '-';
		$num = -$num;
	}

	if($num > 499999999) {
		return '(nihil)';
	}

	if($num > 99999) {
		$rnum .= '|';
		$rnum .= roman($num / 100000);
		$rnum .= '|';
		$num %= 100000;
	}

	if($num > 4999) {
		$rnum .= '_';
		$rnum .= roman($num / 1000);
		$rnum .= '_';
		$num %= 1000;
	}

	for (my $i = 0; $i < @numbers; $i++) {
		while ($num >= $numbers[$i]) {
			$rnum .= $letters[$i];
			$num -= $numbers[$i];
		}
	}

	return $rnum;
}

sub getKarma {
	my $nick = shift;
	$conf->AddSection(KARMA);
	my $karma = $conf->val(KARMA, $nick);
	$karma = 0 if (!defined $karma);
	return $karma;
}

sub incKarma {
	my $nick = shift;
	$conf = Config::IniFiles->new(-file => INIFILE, -allowempty => 1);
	$conf->SectionExists(KARMA) or $conf->AddSection(KARMA);
	my $karma = $conf->val(KARMA, $nick, 0);
	$conf->newval(KARMA, $nick, $karma + 1);
	$conf->RewriteConfig();
}

while(1) {
	sleep(1);
	my $newday = (localtime(time))[3];
	if($newday != $day) {
		$day = $newday;
		@pranzonauti = ();
	}

	my $res = $ua->get("$api/getUpdates?limit=1&offset=$lastid");
	if ($res->is_success) {
		my $json = decode_json($res->content);
		if (! defined $json->{result}[0]) {
			next;
		}
		my $msg = $json->{result}->[0]->{message};
		$lastid = $json->{result}->[0]->{update_id} + 1;

		if (! defined $msg->{text}) {
			if (defined $msg->{venue} && defined $msg->{venue}->{location}) {
				$lastpos{$msg->{from}->{id}} = $msg->{venue}->{location};
			} elsif (defined $msg->{location}) {
				$lastpos{$msg->{from}->{id}} = $msg->{location};
			}
			next;
		}

		my $chat = $msg->{chat}->{id};
		my $from = $msg->{from}->{first_name};
		my $text = $msg->{text};
		my @mentions = ();
		my @commands = ();

		# commands and messages to me
		if (defined $msg->{entities}) {
			foreach my $ent (@{$msg->{entities}}) {
				my $str = substr($text, $ent->{offset}, $ent->{length});
				if ($ent->{type} eq 'mention') {
					push @mentions, $str;
				} elsif ($ent->{type} eq 'bot_command' && $str =~ /^(\/[^ @]+)($myusername)?$/) {
					push @commands, $1;
				}
			}
		}

		if (@mentions == 1 && $text =~ /^$myusername[:, ](.*)\?$/) {
			if($nextreply) {
				$ua->get("$api/sendMessage?chat_id=$chat&text=$nextreply");
				$nextreply = '';
			} else {
				$res = $ua->get("https://www.googleapis.com/customsearch/v1?key=$key&cx=$cx&hl=it&num=1&q=$1");
				if ($res->is_success) {
					my $json = decode_json($res->content);
					if (defined $json->{items}[0]->{link}) {
						$ua->post("$api/sendMessage", [ chat_id => $chat, text => $json->{items}[0]->{link} ]);
					} else {
						$ua->get("$api/sendMessage?chat_id=$chat&text=boh");
					}
				}
			}
		} elsif (@mentions == 1 && $text =~ /^(offendi|insulta) (@.*)$/i) {
			if($2 eq $myusername) {
				$ua->get("$api/sendMessage?chat_id=$chat&text=dottore, chiami un dottore!");
			} else {
				$ua->post("$api/sendMessage", [ chat_id => $chat, text => "$2 $offese[rand @offese]" ]);
			}
		} elsif (@mentions == 1 && $text =~ /^$mentions[0]\s*\+\+$/) {
			if($mentions[0] ne $myusername) {
				$conf = Config::IniFiles->new(-file => INIFILE, -allowempty => 1);
				my $ircnick = $conf->val('nickmappings', substr($mentions[0], 1), undef);
				incKarma($ircnick);
			}
		} elsif (findreply($text, \@voices)) {
			my $file = SOUNDDIR.findreply($text, \@voices).'.opus';
			$ua->post("$api/sendVoice", Content_Type => 'multipart/form-data', Content => [ chat_id => $chat, voice => [ $file ] ]);
		} elsif ($text =~ /\b(da |as)solo|chitarra\b/i) {
			my $file = SOLODIR.($solos[rand @solos]).'.opus';
			$ua->post("$api/sendVoice", Content_Type => 'multipart/form-data', Content => [ chat_id => $chat, voice => [ $file ] ]);
		} elsif (findreply($text, \@kickwords)) {
			$ua->post("$api/sendMessage", [ chat_id => $chat, text => findreply($text, \@kickwords) ]);
			$ua->get("$api/kickChatMember?chat_id=$chat&user_id=".$msg->{from}->{id});
			$ua->get("$api/unbanChatMember?chat_id=$chat&user_id=".$msg->{from}->{id});
		} elsif (findreply($text, \@replies)) {
			$ua->post("$api/sendMessage", [ chat_id => $chat, text => findreply($text, \@replies) ]);
		} elsif ($text =~ /\b[wl]an\b/i) {
			my @reti = ('LAN', 'WAN');
			$ua->get("$api/sendMessage?chat_id=$chat&text=da ".$reti[rand @reti].' a '.$reti[rand @reti]);
		} elsif ($text =~ /\b$myname\b/i) {
			$ua->post("$api/sendMessage", [ chat_id => $chat, text => $pongs[rand @pongs] ]);
		} elsif ($text =~ /^karma (.+)/) {
			$conf = Config::IniFiles->new(-file => INIFILE, -allowempty => 1);
			$ua->post("$api/sendMessage", [ chat_id => $chat, text => "$1 ha karma ".getKarma($1) ]);
		} elsif (@commands == 1) {
			if ($commands[0] eq '/karmas') {
				$conf = Config::IniFiles->new(-file => INIFILE, -allowempty => 1);
				my $resp = "Karma list:\n";
				foreach my $k ($conf->Parameters(KARMA)) {
					my $karma = $conf->val(KARMA, $k);
					$resp .= "$k:$karma\n";
				}
				$resp .= 'ChuckNorris:'.$karmachuck[rand @karmachuck]."\n";
				$ua->post("$api/sendMessage", [ chat_id => $chat, text => $resp ]);
			} elsif ($commands[0] eq '/mangio') {
				if(!grep(/$from/, @pranzonauti)) {
					push @pranzonauti, $from;
				}
				$ua->get("$api/sendMessage?chat_id=$chat&text=ok");
			} elsif ($commands[0] eq '/salto') {
				if(grep(/$from/, @pranzonauti)) {
					my $i = 0;
					$i++ until $pranzonauti[$i] eq $from;
					splice(@pranzonauti, $i, 1);
				}
				$ua->get("$api/sendMessage?chat_id=$chat&text=finocchio");
			} elsif ($commands[0] eq '/chimagna') {
				if(@pranzonauti) {
					$ua->post("$api/sendMessage", [ chat_id => $chat, text => join(', ', @pranzonauti)."\nper un totale di ".@pranzonauti." pranzonauti" ]);
				} else {
					$ua->get("$api/sendMessage?chat_id=$chat&text=niente mangiare, niente bere, per i prossimi 20 giorni" );
				}
			} elsif ($commands[0] eq '/ndosemagna') {
				if (! defined $lastpos{$msg->{from}->{id}}) {
					$ua->get("$api/sendMessage?chat_id=$chat&text=ndo cazzo stai?");
				} else {
					my $pos = $lastpos{$msg->{from}->{id}};
					$res = $ua->get("https://maps.googleapis.com/maps/api/place/nearbysearch/json?location=$pos->{latitude},$pos->{longitude}&radius=800&type=food&key=$key");
					if ($res->is_success) {
						my $json = decode_json($res->content);
						my $places = $json->{results};
						if (@$places > 0) {
							my $place = $$places[rand @$places];
							print Dumper($place);
							$ua->post("$api/sendVenue", [
								chat_id => $chat,
								latitude => $place->{geometry}->{location}->{lat},
								longitude => $place->{geometry}->{location}->{lng},
								title => $place->{name},
								address => $place->{vicinity}
							]);
						} else {
							$ua->get("$api/sendMessage?chat_id=$chat&text=a casa tua");
						}
					}
				}
			} elsif ($commands[0] =~ /^\/(tette|culo|maschione)$/) {
				my $rnd = int(rand(100)) + 1;
				my $wat;
				if ($commands[0] eq '/tette') {
					$wat = 'hot+tits';
				} elsif ($commands[0] eq '/culo') {
					$wat = 'hot+ass';
				} else {
					$wat = 'hot+men';
				}
				$res = $ua->get("https://www.googleapis.com/customsearch/v1?key=$key&cx=$cx&searchType=image&num=1&start=$rnd&q=$wat");
				if ($res->is_success) {
					my $json = decode_json($res->content);
					if (defined $json->{items}[0]->{link}) {
						$res = $ua->get($json->{items}[0]->{link});
						if ($res->is_success) {
							open (IMG, '>/tmp/img.jpg');
							print IMG $res->content;
							close(IMG);
							$ua->post("$api/sendPhoto", Content_Type => 'multipart/form-data', Content => [ chat_id => $chat, photo => [ '/tmp/img.jpg' ] ]);
							unlink('/tmp/img.jpg');
						} else {
							$ua->get("$api/sendMessage?chat_id=$chat&text=usa la fantasia");
						}
					} else {
						$ua->get("$api/sendMessage?chat_id=$chat&text=usa la fantasia");
					}
				} else {
					$ua->get("$api/sendMessage?chat_id=$chat&text=usa la fantasia");
				}
			}
		}
	}
}
